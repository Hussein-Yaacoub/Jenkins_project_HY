pipeline {
  agent any
  options { timestamps() }

  stages {

   
    stage('Setup') {
      steps {
        dir('Jenkins_project') {
          bat """
          rem === Use installed Python path ===
          set "PYEXE=C:\\Users\\LENOVO\\AppData\\Local\\Programs\\Python\\Python313\\python.exe"

          if not exist "%PYEXE%" (
              echo ERROR: Python not found at %PYEXE%
              exit /b 1
          )

          rem === Create venv if not exists ===
          "%PYEXE%" -m venv venv

          rem === Activate & install deps ===
          call venv\\Scripts\\activate.bat
          pip install --upgrade pip
          pip install -r requirements.txt
          """
        }
      }
    }

 
    stage('Lint') {
      steps {
        dir('Jenkins_project') {
          script {
            def rc = bat(
              returnStatus: true,
              script: """
                call venv\\Scripts\\activate.bat
                venv\\Scripts\\flake8 app.py
              """
            )
            echo "flake8 exit code = ${rc}"
            if (rc != 0) {
              currentBuild.result = 'UNSTABLE'
              echo 'Lint warnings/errors present (UNSTABLE).'
            }
          }
        }
      }
    }

 
    stage('Test') {
      steps {
        dir('Jenkins_project') {
          bat """
            call venv\\Scripts\\activate.bat
            venv\\Scripts\\pytest -q --junitxml=junit.xml
          """
        }
      }
    }


    stage('Coverage') {
      steps {
        dir('Jenkins_project') {
          script {
            def rc = bat(
              returnStatus: true,
              script: """
                call venv\\Scripts\\activate.bat
                venv\\Scripts\\coverage run -m pytest -q
                venv\\Scripts\\coverage xml -o coverage_report.xml
                venv\\Scripts\\coverage report -m > coverage_summary.txt
              """
            )
            echo "coverage step exit code = ${rc}"
            if (rc != 0) {
              currentBuild.result = 'UNSTABLE'
              echo 'Coverage step had issues (UNSTABLE).'
            }
          }
        }
      }
    }


    stage('Security Scan') {
      steps {
        dir('Jenkins_project') {
          script {
            def rc = bat(
              returnStatus: true,
              script: """
                call venv\\Scripts\\activate.bat
                venv\\Scripts\\bandit -r . -f json -o bandit_report.json
              """
            )
            echo "bandit exit code = ${rc} (ignored for build status)"
          }
        }
      }
    }

   
    stage('Deploy') {
      steps {
        dir('Jenkins_project') {
          bat """
            call venv\\Scripts\\activate.bat
            if not exist dist mkdir dist
            venv\\Scripts\\python app.py > dist\\program_output.txt
          """

          powershell '''
            Compress-Archive -Path app.py, requirements.txt -DestinationPath dist\\app_release.zip -Force
          '''
        }
      }
    }

  }  // end stages


  post {
    always {
      dir('Jenkins_project') {
        archiveArtifacts artifacts: 'junit.xml,coverage_report.xml,coverage_summary.txt,bandit_report.json,dist/**', fingerprint: true
      }
      cleanWs()
    }
  }
}

