pipeline {
  agent any
  options { timestamps() }

  stages {

    
    stage('Setup') {
      steps {
        // create venv inside Jenkins_project
        dir('Jenkins_project') {
          bat """
          rem === Use YOUR Python path ===
          set "PYEXE=C:\\Users\\LENOVO\\AppData\\Local\\Programs\\Python\\Python313\\python.exe"

          if not exist "%PYEXE%" (
              echo ERROR: Python not found at %PYEXE%
              exit /b 1
          )

          rem === Create / reuse venv ===
          "%PYEXE%" -m venv venv

          rem === Activate & install deps ===
          call venv\\Scripts\\activate.bat
          pip install --upgrade pip
          pip install -r requirements.txt
          """
        }
      }
    }

   
    stage('Lint') {
      steps {
        script {
          def rc = bat(
            returnStatus: true,
            script: """
              call Jenkins_project\\venv\\Scripts\\activate.bat
              Jenkins_project\\venv\\Scripts\\flake8 Jenkins_project\\app.py
            """
          )
          echo "flake8 exit code = ${rc}"
          if (rc != 0) {
            currentBuild.result = 'UNSTABLE'
            echo 'Lint warnings/errors present (UNSTABLE).'
          }
        }
      }
    }

    
    stage('Test') {
      steps {
        bat """
          call Jenkins_project\\venv\\Scripts\\activate.bat
          pytest -q Jenkins_project --junitxml=Jenkins_project\\junit.xml
        """
      }
    }

   
    stage('Coverage') {
      steps {
        script {
          def rc = bat(
            returnStatus: true,
            script: """
              call Jenkins_project\\venv\\Scripts\\activate.bat
              coverage run -m pytest -q Jenkins_project
              coverage xml -o Jenkins_project\\coverage_report.xml
              coverage report -m > Jenkins_project\\coverage_summary.txt
            """
          )
          echo "coverage step exit code = ${rc}"
          if (rc != 0) {
            currentBuild.result = 'UNSTABLE'
            echo 'Coverage step had issues (UNSTABLE).'
          }
        }
      }
    }

    
    stage('Security Scan') {
      steps {
        script {
          def rc = bat(
            returnStatus: true,
            script: """
              call Jenkins_project\\venv\\Scripts\\activate.bat
              bandit -r Jenkins_project -f json -o Jenkins_project\\bandit_report.json
            """
          )
          echo "bandit exit code = ${rc} (ignored for build status)"
        }
      }
    }

    
    stage('Deploy') {
      steps {
        dir('Jenkins_project') {
          bat """
            call venv\\Scripts\\activate.bat
            if not exist dist mkdir dist
            venv\\Scripts\\python app.py > dist\\program_output.txt
          """
          powershell '''
            Compress-Archive -Path app.py, requirements.txt -DestinationPath dist\\app_release.zip -Force
          '''
        }
      }
    }
  }

  post {
    always {
      // archive from inside Jenkins_project to keep simple paths
      dir('Jenkins_project') {
        archiveArtifacts artifacts: 'junit.xml,coverage_report.xml,coverage_summary.txt,bandit_report.json,dist/**', fingerprint: true
      }
      cleanWs()
    }
  }
}
